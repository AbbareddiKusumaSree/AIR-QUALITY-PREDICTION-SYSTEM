<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Air Quality - Unified Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <!-- date adapter for Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{--green:#2e7d32;--light:#f6fbf6;--card:#ffffff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--light);color:#0b0b0b}
    .container{display:flex;min-height:100vh}
    .sidebar{width:300px;padding:18px;background:linear-gradient(#eef9ef,#e8f5e9);border-right:1px solid #e6efe6}
    .sidebar h2{color:var(--green);margin:0 0 12px;font-size:18px}
    .sidebar label{display:block;margin-top:12px;font-weight:700;color:#215c21}
    select, button{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #dfeee0}
    .pollutants{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pollutants button{padding:6px 10px;border-radius:6px;border:none;background:#cfe8cf;cursor:pointer;font-weight:700}
    .pollutants button.active{background:var(--green);color:#fff}
    .apply{margin-top:10px;background:var(--green);color:#fff;font-weight:800}
    .small{font-size:13px;color:#2b6f2b;margin-top:8px}
    .data-quality{margin-top:18px;background:var(--card);padding:10px;border-radius:8px;border:1px solid #eef7ee}
    .dashboard{flex:1;padding:22px}
    header h1{margin:0;color:var(--green);font-size:24px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-top:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 4px 18px rgba(30,80,30,0.04);border:1px solid #f1f7f1}
    .card h3{margin:0 0 8px 0;color:#2d6f2d}
    .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .stat{background:#f3faf3;padding:10px;border-radius:8px;text-align:center}
    .stat .num{font-weight:800;color:var(--green);font-size:16px}
    canvas{width:100% !important;height:300px !important}
    .footer-note{margin-top:12px;font-size:13px;color:#4d724d}
    .loading{padding:10px;background:#fff;border-radius:8px;margin-top:10px}
    @media(max-width:1000px){ .container{flex-direction:column}.sidebar{width:100%}.grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <h2>Controls</h2>

      <label>Dataset</label>
      <select id="datasetType">
        <option value="city_day">City — Daily</option>
        <option value="city_hour">City — Hourly</option>
        <option value="station_day">Station — Daily</option>
        <option value="station_hour">Station — Hourly</option>
      </select>

      <label>Location (City / Station)</label>
      <select id="locationSelect"><option>Loading...</option></select>

      <label>Time Range</label>
      <select id="timeRange">
        <option value="1d">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
        <option value="all">All</option>
      </select>

      <label>Pollutants (select one or more)</label>
      <div class="pollutants" id="pollutantButtons">
        <button data-poll="PM2.5" class="active">PM2.5</button>
        <button data-poll="PM10">PM10</button>
        <button data-poll="NO2">NO2</button>
        <button data-poll="O3">O3</button>
        <button data-poll="SO2">SO2</button>
        <button data-poll="CO">CO</button>
      </div>

      <button id="applyBtn" class="apply">Apply</button>

      <div class="data-quality">
        <div class="small"><strong>Data Quality</strong></div>
        <div>Completeness: <span id="completeness">--</span></div>
        <div>Validity: <span id="validity">--</span></div>
      </div>

      <div class="loading" id="statusBox">Status: idle</div>
      <div class="footer-note">Files loaded from <span id="dataPathLabel">../data/processed/</span></div>
    </aside>

    <main class="dashboard">
      <header><h1>Air Quality Explorer</h1></header>

      <section class="grid">
        <div class="card">
          <h3 id="tsTitle">PM2.5 Time Series</h3>
          <canvas id="tsChart"></canvas>
        </div>

        <div class="card">
          <h3>Pollutant Correlations (bubble)</h3>
          <canvas id="corrChart"></canvas>
        </div>

        <div class="card summary">
          <h3>Statistical Summary</h3>
          <div class="stats-grid">
            <div class="stat"><div class="num" id="mean">--</div><div>Mean</div></div>
            <div class="stat"><div class="num" id="median">--</div><div>Median</div></div>
            <div class="stat"><div class="num" id="max">--</div><div>Max</div></div>
            <div class="stat"><div class="num" id="min">--</div><div>Min</div></div>
            <div class="stat"><div class="num" id="std">--</div><div>Std Dev</div></div>
            <div class="stat"><div class="num" id="count">--</div><div>Count</div></div>
          </div>
        </div>

        <div class="card">
          <h3>Distribution (histogram)</h3>
          <canvas id="histChart"></canvas>
        </div>
      </section>
    </main>
  </div>

<script>
/* ----------------------------
  Unified dashboard script
   - supports city_day, city_hour, station_day, station_hour
   - expects processed CSVs in ../data/processed/
   - uses Chart.js + PapaParse
   ----------------------------*/

const DATASETS = {
  city_day: "/data/processed/city_day_processed.csv",
  city_hour: "/data/processed/city_hour_processed.csv",
  station_day: "/data/processed/station_day_processed.csv",
  station_hour: "/data/processed/station_hour_processed.csv"
};
// fallback inside dashboard/data/
const FALLBACK = {
  city_day: "data/city_day_processed.csv",
  city_hour: "data/city_hour_processed.csv",
  station_day: "data/station_day_processed.csv",
  station_hour: "data/station_hour_processed.csv"
};

const POLLUTANTS = ["PM2.5","PM10","NO2","O3","SO2","CO"];
const COLORS = ["#2e7d32","#c62828","#1565c0","#ff8f00","#6a1b9a","#00897b","#b71c1c","#6d4c41"];

let datasetType = "city_day";
let rawData = [];               // full CSV rows
let filteredRows = [];          // after filtering by location/time
let currentLocation = null;
let selectedPollutants = ["PM2.5"];

let tsChart, corrChart, histChart;

const statusBox = document.getElementById("statusBox");
const dataPathLabel = document.getElementById("dataPathLabel");

// utility
function setStatus(msg){ statusBox.innerText = "Status: " + msg; }
function parseDateAny(s){
  if(!s) return null;
  // try common formats
  let d = new Date(s);
  if(!isNaN(d)) return d;
  // try numeric timestamp
  let n = Number(s);
  if(!isNaN(n)) return new Date(n);
  return null;
}
function safeNum(v){ return v===null || v==="" || v===undefined ? null : Number(v); }
function fmt(n){ return (n===null||n===undefined||isNaN(n)) ? "--" : (Math.round(n*100)/100).toString(); }

// attempt to load CSV using PapaParse. try primary then fallback
async function loadDataset(key){
  const p = DATASETS[key];
  const fb = FALLBACK[key];
  setStatus("loading " + p + " ...");
  dataPathLabel.innerText = p;
  try{
    const res = await papaParseFetch(p);
    if(res && res.length>0){ setStatus("Loaded " + p); return res; }
    throw new Error("Empty");
  }catch(e){
    setStatus("failed primary, trying fallback...");
    dataPathLabel.innerText = fb;
    try{
      const res2 = await papaParseFetch(fb);
      if(res2 && res2.length>0){ setStatus("Loaded " + fb); return res2; }
      throw new Error("Empty fallback");
    }catch(e2){
      setStatus("CSV not found. Put processed CSVs in ../data/processed/ or dashboard/data/");
      console.error("Failed to load dataset", p, fb, e2);
      return null;
    }
  }
}
function papaParseFetch(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url, { download:true, header:true, skipEmptyLines:true,
      complete: (res)=> resolve(res.data),
      error: (err)=> reject(err)
    });
  });
}

function normalizeRows(rows){
  // map input rows into uniform format:
  // Date (Date object), City or Station, pollutant numeric fields...
  return rows.map(r=>{
    const out = {};
    // robust date detection: try Datetime, Date, timestamp
    out.raw = r;
    out.Date = parseDateAny(r.Datetime || r.Date || r.Timestamp || r.datetime || r.timestamp);
    // City or Station detection: prefer City then Station
    out.City = r.City || r.city || r.CityName || null;
    out.Station = r.Station || r.station || r.StationCode || null;
    POLLUTANTS.forEach(p=>{
      // many CSVs might have "PM2_5" or "PM2.5" ==> handle both
      let v = r[p] !== undefined ? r[p] : (r[p.replace('.','_')] !== undefined ? r[p.replace('.','_')] : r[p.replace('.','')]);
      out[p] = (v===undefined || v==="" ) ? null : Number(v);
    });
    return out;
  }).filter(r=>r.Date instanceof Date && !isNaN(r.Date));
}

function populateLocationSelector(rows){
  const key = datasetType.startsWith("city") ? "City" : "Station";
  const locs = Array.from(new Set(rows.map(r=>r[key]).filter(Boolean))).sort();
  const sel = document.getElementById("locationSelect");
  sel.innerHTML = locs.map(l=>`<option value="${l}">${l}</option>`).join("");
  if(locs.length>0){
    currentLocation = locs[0];
    sel.value = currentLocation;
  } else {
    currentLocation = null;
    sel.innerHTML = "<option>-- no locations --</option>";
  }
}

// build charts
function initCharts(){
  const ctxTS = document.getElementById("tsChart").getContext("2d");
  tsChart = new Chart(ctxTS, {
    type: 'line',
    data: { labels: [], datasets: [] },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      scales: {
        x: { type: 'time', time: { tooltipFormat: 'PP p' }, title:{display:true,text:'Time'} },
        y: { beginAtZero:true, title:{display:true,text:'Concentration'} }
      },
      plugins: { legend:{display:true,position:'bottom'} }
    }
  });

  const ctxCorr = document.getElementById("corrChart").getContext("2d");
  corrChart = new Chart(ctxCorr, {
    type: 'bubble',
    data: { datasets: [] },
    options: {
      responsive:true,
      scales: {
        x: { ticks:{stepSize:1, callback: v => (POLLUTANTS[v]||'') }, min:0, max:POLLUTANTS.length-1 },
        y: { ticks:{stepSize:1, callback: v => (POLLUTANTS[v]||'') }, min:0, max:POLLUTANTS.length-1 }
      },
      plugins:{legend:{display:false}}
    }
  });

  const ctxHist = document.getElementById("histChart").getContext("2d");
  histChart = new Chart(ctxHist, {
    type: 'bar',
    data: { labels: [], datasets: [{ label:'Frequency', data:[], backgroundColor: 'rgba(46,125,50,0.6)' }] },
    options:{ responsive:true, scales:{ x:{title:{display:true,text:'Range'}}, y:{title:{display:true,text:'Frequency'}} } }
  });
}

function computeDataQuality(rows){
  if(!rows || rows.length===0) return {completeness:'--',validity:'--'};
  let total=0, present=0, valid=0, checked=0;
  rows.forEach(r=>{
    POLLUTANTS.forEach(p=>{
      total++;
      const v = r[p];
      if(v!==null && v!==undefined && v!==""){ present++; }
      if(v!==null && v!==undefined && !isNaN(v)){ checked++; if(v>=0 && v<10000) valid++; }
    });
  });
  const completeness = Math.round((present/total)*100);
  const validity = Math.round((valid/checked)*100);
  return {completeness,validity};
}

function applyUIHandlers(){
  document.getElementById("datasetType").addEventListener("change", async (e)=>{
    datasetType = e.target.value;
    await reloadData();
  });
  document.getElementById("locationSelect").addEventListener("change", (e)=>{
    currentLocation = e.target.value; renderAll();
  });
  document.getElementById("applyBtn").addEventListener("click", ()=> renderAll());
  // pollutant buttons: toggle multi-select
  document.querySelectorAll("#pollutantButtons button").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      const p = e.target.dataset.poll;
      e.target.classList.toggle("active");
      if(e.target.classList.contains("active")){
        if(!selectedPollutants.includes(p)) selectedPollutants.push(p);
      } else {
        selectedPollutants = selectedPollutants.filter(x=>x!==p);
        // ensure at least one remains
        if(selectedPollutants.length===0){ selectedPollutants.push(p); e.target.classList.add("active"); }
      }
      document.getElementById("tsTitle").innerText = (selectedPollutants.length>1 ? selectedPollutants.join(" / ") : selectedPollutants[0]) + " Time Series";
      renderAll();
    });
  });
  document.getElementById("timeRange").addEventListener("change", ()=> renderAll());
}

function filterByLocationAndRange(rows){
  if(!currentLocation) return [];
  const key = datasetType.startsWith("city") ? "City" : "Station";
  let out = rows.filter(r=>r[key]===currentLocation);
  out.sort((a,b)=>a.Date - b.Date);
  const timeRange = document.getElementById("timeRange").value;
  if(timeRange !== 'all' && out.length>0){
    const last = out[out.length-1].Date;
    const from = new Date(last);
    if(timeRange==='1d') from.setDate(last.getDate()-1);
    else if(timeRange==='7d') from.setDate(last.getDate()-7);
    else if(timeRange==='30d') from.setDate(last.getDate()-30);
    out = out.filter(r=>r.Date >= from && r.Date <= last);
  }
  return out;
}

function updateTS(rows){
  const datasets = [];
  selectedPollutants.forEach((poll, idx)=>{
    const data = rows.map(r=> ({x:r.Date, y: r[poll]===null?NaN:r[poll]}));
    datasets.push({
      label: poll,
      data,
      borderColor: COLORS[idx % COLORS.length],
      backgroundColor: COLORS[idx % COLORS.length],
      tension:0.15,
      spanGaps:true,
      pointRadius:1,
      yAxisID: 'y'
    });
  });
  tsChart.data.datasets = datasets;
  tsChart.update();
}

function updateSummary(rows){
  const poll = selectedPollutants[0];
  const vals = rows.map(r=>r[poll]).filter(v=>v!==null && !isNaN(v));
  if(vals.length===0){
    ["mean","median","max","min","std","count"].forEach(id=>document.getElementById(id).innerText="--");
    return;
  }
  const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
  const sorted = vals.slice().sort((a,b)=>a-b);
  const median = sorted[Math.floor(sorted.length/2)];
  const max = Math.max(...vals), min = Math.min(...vals);
  const std = Math.sqrt(vals.map(v=> (v-mean)**2 ).reduce((a,b)=>a+b,0)/vals.length);
  document.getElementById("mean").innerText = fmt(mean);
  document.getElementById("median").innerText = fmt(median);
  document.getElementById("max").innerText = fmt(max);
  document.getElementById("min").innerText = fmt(min);
  document.getElementById("std").innerText = fmt(std);
  document.getElementById("count").innerText = vals.length;
}

function updateHist(rows){
  const poll = selectedPollutants[0];
  const vals = rows.map(r=>r[poll]).filter(v=>v!==null && !isNaN(v));
  if(vals.length===0){ histChart.data.labels=[]; histChart.data.datasets[0].data=[]; histChart.update(); return; }
  const bins = 8;
  const min = Math.min(...vals), max = Math.max(...vals);
  const step = (max - min) / bins || 1;
  const counts = new Array(bins).fill(0);
  vals.forEach(v=>{
    const i = Math.min(bins-1, Math.floor((v - min)/step));
    counts[i] += 1;
  });
  const labels = Array.from({length:bins}, (_,i) => `${Math.round(min + i*step)} - ${Math.round(min + (i+1)*step)}`);
  histChart.data.labels = labels;
  histChart.data.datasets[0].data = counts;
  histChart.update();
}

function updateCorr(rows){
  const pairs = [];
  for(let i=0;i<POLLUTANTS.length;i++){
    for(let j=i+1;j<POLLUTANTS.length;j++){
      const a = POLLUTANTS[i], b = POLLUTANTS[j];
      const aligned = rows.map(r=>[r[a], r[b]]).filter(x=>x[0]!==null && x[1]!==null && !isNaN(x[0]) && !isNaN(x[1]));
      if(aligned.length < 6) continue;
      const ax = aligned.map(x=>x[0]), by = aligned.map(x=>x[1]);
      const meanA = ax.reduce((s,v)=>s+v,0)/ax.length;
      const meanB = by.reduce((s,v)=>s+v,0)/by.length;
      const num = ax.map((v,k)=> (v-meanA)*(by[k]-meanB) ).reduce((s,v)=>s+v,0);
      const den = Math.sqrt(ax.map(v=> (v-meanA)**2 ).reduce((s,v)=>s+v,0) * by.map(v=> (v-meanB)**2 ).reduce((s,v)=>s+v,0) );
      const corr = den ? (num/den) : 0;
      pairs.push({
        x: i, y: j, r: Math.min(30, Math.abs(corr)*30), corr
      });
    }
  }
  corrChart.data.datasets = [{
    label:'correlation',
    data: pairs,
    backgroundColor: pairs.map(p => p.corr >=0 ? 'rgba(46,125,50,0.6)' : 'rgba(214,63,64,0.6)')
  }];
  corrChart.update();
}

function renderAll(){
  if(!rawData || rawData.length===0){ setStatus("No data loaded"); return; }
  filteredRows = filterByLocationAndRange(rawData);
  const dq = computeDataQuality(filteredRows);
  document.getElementById("completeness").innerText = dq.completeness + "%";
  document.getElementById("validity").innerText = dq.validity + "%";
  updateTS(filteredRows);
  updateSummary(filteredRows);
  updateHist(filteredRows);
  updateCorr(filteredRows);
  setStatus(`Rendered (${filteredRows.length} rows)`);
}

async function reloadData(){
  setStatus("loading dataset...");
  const raw = await loadDataset(datasetType);
  if(!raw){ setStatus("Failed to load dataset"); return; }
  const norm = normalizeRows(raw);
  rawData = norm;
  populateLocationSelector(norm);
  // set UI defaults
  const buttons = document.querySelectorAll("#pollutantButtons button");
  buttons.forEach(b => {
    if(b.dataset.poll === "PM2.5"){ b.classList.add("active"); selectedPollutants = ["PM2.5"]; } else b.classList.remove("active");
  });
  document.getElementById("timeRange").value = "30d";
  renderAll();
}

// initial boot
(async function boot(){
  try{
    initCharts();
    applyUIHandlers();
    await reloadData();
    setStatus("Ready");
  }catch(err){
    console.error(err);
    setStatus("Error: " + (err.message||err));
  }
})();

</script>
</body>
</html>